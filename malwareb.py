import requests
import os
from dotenv import load_dotenv
import shutil
from pathlib import Path
from malwarebazaar import Bazaar


# Load environment variables from .env file
load_dotenv()
api_url = 'https://mb-api.abuse.ch/api/v1/'  # Base URL for MalwareBazaar API
Mb_api_key = os.getenv("Malware_Bazaar_API_KEY")


def download_file_from_malwarebazaar(url, downloaded_file_path):
    sha256_hash = url.split('/')[-2]
    bazaar_api = Bazaar(api_key=Mb_api_key)
    result = bazaar_api.download_file(sha256_hash)
    if result:
        with open(downloaded_file_path, 'wb') as file:
            file.write(result)
        print(f"File downloaded and saved to {downloaded_file_path}")
    else:
        print(f"Failed to download the file.")

# def download_file_from_malwarebazaar(url, file_path):
#     sha256_hash = url.split('/')[-2]
#     download_url = f'{api_url}file/{sha256_hash}/'
#     payload = {'query': 'get_file', 'sha256_hash': sha256_hash}
#     headers = {'API-KEY': Mb_api_key}

#     response = requests.get(api_url, 
#                             data=payload, 
#                             headers=headers)
#     if response.status_code == 200:
#         with open(file_path, 'wb') as file:
#             file.write(response.content)
#         print(f"File downloaded and saved to {file_path}.")
#     else:
#         print(f"Failed to download the file. Status code: {response.status_code}")


# def download_file_from_malwarebazaar(url, file_path):
#     sha256_hash = url.split('/')[-2]
#     headers = {'API-KEY': Mb_api_key}
#     payload = {'query': 'get_file', 'sha256_hash': sha256_hash}
#     # Download file from the provided URL
#     response = requests.post(url, headers=headers, data=payload)
#     if response.status_code == 200:
#         # Save the downloaded content to the specified file path
#         with open(file_path, "wb") as file:
#             for chunk in response.iter_content(chunk_size=128):
#                 file.write(chunk)
#             print("File downloaded successfully.")
#             return file_path
#     else:
#         print(f"Failed to download file from the URL: {url}")
#         return None

# download_file_from_malwarebazaar(url="https://bazaar.abuse.ch/sample/7693aae819937d6b3d4a8427a16dedc38c0caf0a3988a284c5d1dd7b269eb60d/", file_path=Path('/tmp/filetoscan'))